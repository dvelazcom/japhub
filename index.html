<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Video Transcript Player with Native CC</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    /* Video Panel */
    .video-panel {
      flex: 6;
      display: flex;
      flex-direction: column;
      background: #000;
      padding: 20px;
      padding-top: calc(60px + env(safe-area-inset-top));
      overflow: hidden;
    }
    .video-wrapper {
      position: relative;
      flex-shrink: 0;
      margin-bottom: 20px;
    }
    #video-player {
      width: 100%;
      height: auto;
      max-height: 60vh;
      background: #000;
      border-radius: 8px;
      display: block;
    }
    .controls {
      flex-shrink: 0;
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      padding: 15px 0;
    }
    button {
      min-height: 44px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #007AFF;
      color: white;
      cursor: pointer;
      font-weight: 500;
      flex-shrink: 0;
    }
    button:hover {
      background: #0051D5;
    }
    button:active {
      background: #003d99;
    }
    .subtitle-counter {
      font-size: 18px;
      font-weight: 600;
      padding: 12px 24px;
      background: #1c1c1e;
      border-radius: 8px;
      color: #fff;
      flex-shrink: 0;
    }
    /* Transcript Panel */
    .transcript-panel {
      flex: 4;
      background: #1c1c1e;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #38383a;
      overflow: hidden;
    }
    .transcript-header {
      flex-shrink: 0;
      padding: 20px;
      padding-top: calc(20px + env(safe-area-inset-top));
      background: #2c2c2e;
      border-bottom: 1px solid #38383a;
    }
    .transcript-header h2 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    .transcript-info {
      font-size: 14px;
      color: #98989d;
      line-height: 1.4;
    }
    .transcript-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      scroll-behavior: smooth;
    }
    .transcript-item {
      padding: 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      transition: background 0.2s;
      user-select: text;
      -webkit-user-select: text;
      cursor: text;
    }
    .transcript-item:hover {
      background: #2c2c2e;
    }
    .transcript-item.active {
      background: #007AFF;
      color: #fff;
    }
    .transcript-item.past {
      opacity: 0.6;
    }
    .transcript-timestamp {
      font-size: 12px;
      color: #98989d;
      margin-bottom: 5px;
      font-weight: 500;
      pointer-events: none;
    }
    .transcript-item.active .transcript-timestamp {
      color: rgba(255,255,255,0.8);
    }
    .transcript-text {
      font-size: 16px;
      line-height: 1.6;
    }
    .transcript-content::-webkit-scrollbar {
      width: 8px;
    }
    .transcript-content::-webkit-scrollbar-track {
      background: #1c1c1e;
    }
    .transcript-content::-webkit-scrollbar-thumb {
      background: #48484a;
      border-radius: 4px;
    }
    .transcript-content::-webkit-scrollbar-thumb:hover {
      background: #58585a;
    }
    /* Upload Screen */
    .upload-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow-y: auto;
    }
    .upload-container {
      background: #1c1c1e;
      padding: 40px;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      margin: 20px;
    }
    .upload-container h1 {
      margin-bottom: 30px;
      font-size: 28px;
    }
    .file-section {
      margin: 25px 0;
      padding: 20px;
      background: #2c2c2e;
      border-radius: 12px;
    }
    .file-section h3 {
      margin-bottom: 15px;
      color: #98989d;
      font-size: 16px;
    }
    .file-btn {
      width: 100%;
      margin: 10px 0;
      min-height: 50px;
    }
    .file-info {
      margin-top: 10px;
      padding: 12px;
      background: #007AFF;
      border-radius: 8px;
      font-size: 14px;
    }
    /* Responsive */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      .video-panel {
        flex: 0 0 auto;
        max-height: 50vh;
        padding-bottom: 10px;
      }
      .transcript-panel {
        flex: 1;
        border-left: none;
        border-top: 1px solid #38383a;
      }
      #video-player {
        max-height: 40vh;
      }
    }
  </style>
</head>
<body>
  <!-- Upload Screen -->
  <div id="upload-screen" class="upload-screen">
    <div class="upload-container">
      <h1>üì∫ Video Transcript Player</h1>
      
      <div class="file-section">
        <h3>SELECT VIDEO FILE</h3>
        <button class="file-btn" id="select-video-btn">Choose Video</button>
        <input type="file" id="video-file-input" accept="video/*" style="display: none;">
        <div id="video-filename" class="file-info" style="display: none;"></div>
      </div>
      
      <div class="file-section">
        <h3>SELECT SUBTITLE FILE</h3>
        <button class="file-btn" id="select-subtitle-btn">Choose Subtitle</button>
        <input type="file" id="subtitle-file-input" accept="text/plain,.srt,.vtt,.txt,.ass,text/*,*/*" style="display: none;">
        <div id="subtitle-filename" class="file-info" style="display: none;"></div>
      </div>
      
      <button id="load-player-btn" class="file-btn" disabled style="background: #34C759; font-size: 18px;">
        ‚ñ∂Ô∏è Load Player
      </button>
    </div>
  </div>
  
  <!-- Player Screen -->
  <div id="player-screen" class="container" style="display: none;">
    <!-- Video Panel -->
    <div class="video-panel">
      <div class="video-wrapper">
        <video id="video-player" controls crossorigin="anonymous">
          <!-- Native subtitle track will be inserted here dynamically -->
        </video>
      </div>
      
      <div class="controls">
        <button id="prev-btn">‚¨ÖÔ∏è Previous</button>
        <span class="subtitle-counter" id="subtitle-counter">0 / 0</span>
        <button id="next-btn">Next ‚û°Ô∏è</button>
      </div>
    </div>
    
    <!-- Transcript Panel -->
    <div class="transcript-panel">
      <div class="transcript-header">
        <h2>Transcript</h2>
        <p class="transcript-info">Select text to copy for Manabi Reader ‚Ä¢ Use arrows to navigate ‚Ä¢ Enable CC in video player for fullscreen subtitles</p>
      </div>
      
      <div id="transcript-content" class="transcript-content">
        <!-- Transcript items -->
      </div>
    </div>
  </div>

  <script>
    let videoFile = null;
    let subtitleFile = null;
    let subtitles = [];
    let currentIndex = 0;

    window.addEventListener('DOMContentLoaded', () => {
      attachEventListeners();
    });

    function attachEventListeners() {
      document.getElementById('select-video-btn').addEventListener('click', () => {
        document.getElementById('video-file-input').click();
      });
      
      document.getElementById('select-subtitle-btn').addEventListener('click', () => {
        document.getElementById('subtitle-file-input').click();
      });
      
      document.getElementById('video-file-input').addEventListener('change', handleVideoSelect);
      document.getElementById('subtitle-file-input').addEventListener('change', handleSubtitleSelect);
      document.getElementById('load-player-btn').addEventListener('click', loadPlayer);
      
      document.getElementById('prev-btn').addEventListener('click', previousSubtitle);
      document.getElementById('next-btn').addEventListener('click', nextSubtitle);
    }

    function handleVideoSelect(event) {
      const file = event.target.files[0];
      if (file) {
        videoFile = file;
        const info = document.getElementById('video-filename');
        info.textContent = `‚úì ${file.name}`;
        info.style.display = 'block';
        checkLoadButton();
      }
    }

    async function handleSubtitleSelect(event) {
      const file = event.target.files[0];
      if (file) {
        subtitleFile = file;
        const text = await file.text();
        subtitles = parseSRT(text);
        
        const info = document.getElementById('subtitle-filename');
        info.textContent = `‚úì ${file.name} (${subtitles.length} subtitles)`;
        info.style.display = 'block';
        
        checkLoadButton();
      }
    }

    function checkLoadButton() {
      const loadBtn = document.getElementById('load-player-btn');
      if (videoFile && subtitles.length > 0) {
        loadBtn.disabled = false;
      }
    }

    function parseSRT(text) {
      const blocks = text.trim().split(/\n\s*\n/);
      const parsed = [];
      
      blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length >= 3) {
          const timeMatch = lines[1].match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);
          if (timeMatch) {
            const startTime = parseTimestamp(timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]);
            const endTime = parseTimestamp(timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]);
            const text = lines.slice(2).join(' ').trim();
            
            parsed.push({
              start: startTime,
              end: endTime,
              text: text,
              timestamp: formatTimestamp(startTime)
            });
          }
        }
      });
      
      return parsed;
    }

    function parseTimestamp(hours, minutes, seconds, milliseconds) {
      return (parseInt(hours) * 3600) + (parseInt(minutes) * 60) + parseInt(seconds) + (parseInt(milliseconds) / 1000);
    }

    function formatTimestamp(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hrs > 0) {
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Convert SRT to VTT format
    function convertSRTtoVTT(subtitles) {
      let vtt = 'WEBVTT\n\n';
      
      subtitles.forEach((sub, index) => {
        const startTime = formatVTTTime(sub.start);
        const endTime = formatVTTTime(sub.end);
        
        vtt += `${index + 1}\n`;
        vtt += `${startTime} --> ${endTime}\n`;
        vtt += `${sub.text}\n\n`;
      });
      
      return vtt;
    }

    function formatVTTTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      const ms = Math.floor((seconds % 1) * 1000);
      
      return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
    }

    function loadPlayer() {
      document.getElementById('upload-screen').style.display = 'none';
      document.getElementById('player-screen').style.display = 'flex';
      
      const video = document.getElementById('video-player');
      video.src = URL.createObjectURL(videoFile);
      
      // Convert subtitles to VTT and add as track
      const vttContent = convertSRTtoVTT(subtitles);
      const vttBlob = new Blob([vttContent], { type: 'text/vtt' });
      const vttUrl = URL.createObjectURL(vttBlob);
      
      // Remove any existing tracks
      while (video.firstChild) {
        video.removeChild(video.firstChild);
      }
      
      // Add new subtitle track
      const track = document.createElement('track');
      track.kind = 'subtitles';
      track.label = 'Japanese';
      track.srclang = 'ja';
      track.src = vttUrl;
      track.default = true;
      video.appendChild(track);
      
      // Enable the track
      video.addEventListener('loadedmetadata', () => {
        if (video.textTracks && video.textTracks.length > 0) {
          video.textTracks[0].mode = 'showing';
        }
      });
      
      buildTranscript();
      video.addEventListener('timeupdate', handleVideoTimeUpdate);
      
      currentIndex = 0;
      updateActiveSubtitle();
    }

    function buildTranscript() {
      const container = document.getElementById('transcript-content');
      container.innerHTML = '';
      
      subtitles.forEach((subtitle, index) => {
        const item = document.createElement('div');
        item.className = 'transcript-item';
        item.dataset.index = index;
        
        const timestamp = document.createElement('div');
        timestamp.className = 'transcript-timestamp';
        timestamp.textContent = subtitle.timestamp;
        
        const text = document.createElement('div');
        text.className = 'transcript-text';
        text.textContent = subtitle.text;
        
        item.appendChild(timestamp);
        item.appendChild(text);
        container.appendChild(item);
      });
    }

    function handleVideoTimeUpdate() {
      const video = document.getElementById('video-player');
      const currentTime = video.currentTime;
      
      for (let i = 0; i < subtitles.length; i++) {
        if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
          if (i !== currentIndex) {
            currentIndex = i;
            updateActiveSubtitle();
          }
          break;
        }
      }
    }

    function updateActiveSubtitle() {
      document.getElementById('subtitle-counter').textContent = `${currentIndex + 1} / ${subtitles.length}`;
      
      const items = document.querySelectorAll('.transcript-item');
      items.forEach((item, index) => {
        item.classList.remove('active', 'past');
        
        if (index === currentIndex) {
          item.classList.add('active');
          
          const transcriptContainer = document.getElementById('transcript-content');
          const itemTop = item.offsetTop;
          const itemHeight = item.offsetHeight;
          const containerHeight = transcriptContainer.clientHeight;
          
          const scrollTo = itemTop - (containerHeight / 2) + (itemHeight / 2);
          transcriptContainer.scrollTo({
            top: scrollTo,
            behavior: 'smooth'
          });
        } else if (index < currentIndex) {
          item.classList.add('past');
        }
      });
    }

    function jumpToSubtitle(index) {
      const video = document.getElementById('video-player');
      video.currentTime = subtitles[index].start;
      currentIndex = index;
      updateActiveSubtitle();
    }

    function previousSubtitle() {
      if (currentIndex > 0) {
        jumpToSubtitle(currentIndex - 1);
      }
    }

    function nextSubtitle() {
      if (currentIndex < subtitles.length - 1) {
        jumpToSubtitle(currentIndex + 1);
      }
    }
  </script>
</body>
</html>
