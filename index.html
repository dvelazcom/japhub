<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab Miner</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens (Light Mode) */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens (Light Mode) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

            /* Common style patterns */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;

            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            /* Spacing */
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;

                --color-bg-1: rgba(29, 78, 216, 0.15);
                --color-bg-2: rgba(180, 83, 9, 0.15);
                --color-bg-3: rgba(21, 128, 61, 0.15);
                --color-bg-4: rgba(185, 28, 28, 0.15);
                --color-bg-5: rgba(107, 33, 168, 0.15);
                --color-bg-6: rgba(194, 65, 12, 0.15);
                --color-bg-7: rgba(190, 24, 93, 0.15);
                --color-bg-8: rgba(8, 145, 178, 0.15);

                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-primary-active: var(--color-teal-800);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
                --color-info: var(--color-gray-300);
                --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
                --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
                --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
            }
        }

        /* Base styles */
        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            margin: 0;
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            color: var(--color-text);
            letter-spacing: var(--letter-spacing-tight);
        }

        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-md); }

        p {
            margin: 0 0 var(--space-16) 0;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            position: relative;
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--primary:active {
            background: var(--color-primary-active);
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn--secondary:active {
            background: var(--color-secondary-active);
        }

        .btn--outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn--outline:hover {
            background: var(--color-secondary);
        }

        .btn--sm {
            padding: var(--space-4) var(--space-12);
            font-size: var(--font-size-sm);
            border-radius: var(--radius-sm);
        }

        .btn--lg {
            padding: var(--space-10) var(--space-20);
            font-size: var(--font-size-lg);
            border-radius: var(--radius-md);
        }

        .btn--full-width {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Form elements */
        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-md);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-fast) var(--ease-standard),
                box-shadow var(--duration-fast) var(--ease-standard);
        }

        textarea.form-control {
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: var(--focus-outline);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        /* Layout */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            max-width: 1024px;
            margin: 0 auto;
            background: var(--color-background);
        }

        header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--color-surface);
            border-radius: var(--radius-base);
        }

        .view {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius-base);
            margin-bottom: 20px;
        }

        .main-btn {
            display: block;
            width: 100%;
            margin: 15px 0;
            font-size: 18px;
            min-height: 60px;
        }

        .file-section {
            margin: 20px 0;
            padding: 15px;
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
        }

        .file-section button {
            margin: 10px 0;
            width: 100%;
        }

        .file-info {
            margin: 10px 0;
            padding: 10px;
            background: var(--color-bg-3);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        #video-player {
            width: 100%;
            max-height: 500px;
            background: black;
            border-radius: var(--radius-base);
            margin: 20px 0;
        }

        .subtitle-display {
            margin: 20px 0;
            padding: 20px;
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            font-size: 20px;
            line-height: 1.8;
            user-select: text;
            -webkit-user-select: text;
            min-height: 100px;
        }

        .subtitle-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .subtitle-counter {
            font-size: 16px;
            font-weight: 500;
            padding: 10px 20px;
            background: var(--color-bg-1);
            border-radius: var(--radius-sm);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 30px;
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .vocab-stats {
            padding: 15px;
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
            margin: 15px 0;
        }

        .vocab-stats p {
            margin: 8px 0;
            font-size: 16px;
        }

        .help-text {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin: 10px 0;
            padding: 10px;
            background: var(--color-bg-2);
            border-radius: var(--radius-sm);
        }

        button.danger {
            background: var(--color-error) !important;
        }

        button.danger:hover {
            background: var(--color-error) !important;
            opacity: 0.9;
        }

        /* Hide class */
        .hidden {
            display: none !important;
        }

        /* iPad optimizations */
        @media (max-width: 1024px) {
            body {
                padding: 16px;
            }
            
            .modal-content {
                margin: 16px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <button id="home-btn" style="display: none;" class="btn btn--outline btn--sm">‚Üê Home</button>
            <h1>Vocab Miner</h1>
        </header>
        
        <!-- Main View -->
        <div id="main-view" class="view">
            <h2>Welcome</h2>
            <button class="btn btn--primary main-btn" id="watch-btn">üì∫ Watch Mode</button>
            <button class="btn btn--primary main-btn" id="websocket-btn">üí¨ Text/WebSocket Mode</button>
            <button class="btn btn--primary main-btn" id="manage-vocab-btn">üìö Manage Vocabulary</button>
        </div>
        
        <!-- Watch View -->
        <div id="watch-view" class="view" style="display: none;">
            <h2>Watch Mode</h2>
            
            <div class="file-section">
                <h3>1. Select Video File</h3>
                <button id="select-video-btn" class="btn btn--primary">Choose Video</button>
                <input type="file" id="video-file-input" accept="video/*" style="display: none;">
                <div id="video-filename" class="file-info" style="display: none;"></div>
            </div>
            
            <div class="file-section">
                <h3>2. Select Subtitle File</h3>
                <button id="select-subtitle-btn" class="btn btn--primary">Choose Subtitle</button>
                <input type="file" id="subtitle-file-input" accept="text/plain,.srt,.vtt,.txt,.ass,text/*,*/*" style="display: none;">
                <div id="subtitle-filename" class="file-info" style="display: none;"></div>
            </div>
            
            <button id="play-video-btn" disabled class="btn btn--primary btn--full-width" style="margin: 20px 0;">‚ñ∂Ô∏è Play Video</button>
            
            <div id="video-container" style="display: none;">
                <video id="video-player" controls></video>
                
                <div class="subtitle-controls">
                    <button id="prev-subtitle-btn" class="btn btn--outline">‚Üê Previous</button>
                    <span class="subtitle-counter" id="subtitle-counter">0 / 0</span>
                    <button id="next-subtitle-btn" class="btn btn--outline">Next ‚Üí</button>
                </div>
                
                <div class="subtitle-display" id="subtitle-display">
                    Subtitles will appear here...
                </div>
                
                <p class="help-text">
                    üìù Tip: Highlight any text above and click "Mine Selected Text" to add it to your vocabulary
                </p>
                
                <button id="mine-selection-btn" class="btn btn--primary btn--full-width">‚ûï Mine Selected Text</button>
            </div>
        </div>
        
        <!-- WebSocket View -->
        <div id="websocket-view" class="view" style="display: none;">
            <h2>Text/WebSocket Mode</h2>
            
            <div class="form-group">
                <label class="form-label">WebSocket URL:</label>
                <input type="text" id="ws-url" class="form-control" placeholder="ws://localhost:port" />
            </div>
            
            <div class="button-group">
                <button id="ws-connect-btn" class="btn btn--primary">Connect</button>
                <button id="ws-disconnect-btn" disabled class="btn btn--secondary">Disconnect</button>
            </div>
            
            <p id="ws-status" style="margin: 15px 0; padding: 10px; background: var(--color-bg-1); border-radius: var(--radius-sm);">
                Status: Disconnected
            </p>
            
            <div class="subtitle-display" id="ws-text-display">
                Text from WebSocket will appear here...
            </div>
            
            <p class="help-text">
                üìù Tip: Highlight any text above and click "Mine Selected Text"
            </p>
            
            <button id="ws-mine-btn" class="btn btn--primary btn--full-width">‚ûï Mine Selected Text</button>
        </div>
        
        <!-- Vocabulary Manager -->
        <div id="vocab-manager-modal" class="modal">
            <div class="modal-content">
                <h2>Manage Vocabulary</h2>
                
                <div class="vocab-stats">
                    <p><strong>Total Words:</strong> <span id="vocab-count">0</span></p>
                    <p><strong>Last Export:</strong> <span id="last-export">Never</span></p>
                </div>
                
                <div class="button-group" style="flex-direction: column;">
                    <button id="export-all-btn" class="btn btn--primary">üì• Export All as CSV</button>
                    <button id="export-new-btn" class="btn btn--primary">üì• Export New Only</button>
                    <button id="import-btn" class="btn btn--secondary">üì§ Import Vocabulary</button>
                    <input type="file" id="import-file-input" accept=".csv,.tsv,text/*" style="display: none;">
                    <button id="delete-all-btn" class="btn danger">üóëÔ∏è Delete All Vocabulary</button>
                </div>
                
                <button id="close-vocab-btn" class="btn btn--secondary" style="margin-top: 20px; width: 100%;">Close</button>
            </div>
        </div>
        
        <!-- Mining Form -->
        <div id="mining-modal" class="modal">
            <div class="modal-content">
                <h2>Add to Vocabulary</h2>
                
                <div class="form-group">
                    <label class="form-label">Expression (Word):</label>
                    <input type="text" id="expr-input" class="form-control" placeholder="e.g., È£ü„Åπ„Çã" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Expression with Furigana:</label>
                    <input type="text" id="expr-furigana-input" class="form-control" placeholder="e.g., È£ü[„Åü]„Åπ„Çã" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">Definition:</label>
                    <textarea id="def-input" class="form-control" placeholder="e.g., to eat"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sentence (Context):</label>
                    <textarea id="sentence-input" class="form-control" placeholder="Full sentence from subtitle"></textarea>
                </div>
                
                <div class="button-group">
                    <button id="save-vocab-btn" class="btn btn--primary">üíæ Save</button>
                    <button id="cancel-mining-btn" class="btn btn--secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let selectedVideo = null;
        let selectedSubtitle = null;
        let subtitles = [];
        let currentSubIndex = 0;
        let vocabDB = null;
        let websocket = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            await initIndexedDB();
            attachEventListeners();
            updateVocabStats();
        }

        // IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('VocabMinerDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    vocabDB = request.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('vocabulary')) {
                        const store = db.createObjectStore('vocabulary', { keyPath: 'Expression' });
                        store.createIndex('timestamp', 'timestamp');
                        store.createIndex('exported', 'exported');
                    }
                };
            });
        }

        // Event Listeners
        function attachEventListeners() {
            // Navigation
            document.getElementById('watch-btn').addEventListener('click', showWatchView);
            document.getElementById('websocket-btn').addEventListener('click', showWebSocketView);
            document.getElementById('manage-vocab-btn').addEventListener('click', showVocabManager);
            document.getElementById('home-btn').addEventListener('click', showMainView);
            
            // File selection
            document.getElementById('select-video-btn').addEventListener('click', () => {
                document.getElementById('video-file-input').click();
            });
            document.getElementById('select-subtitle-btn').addEventListener('click', () => {
                document.getElementById('subtitle-file-input').click();
            });
            
            document.getElementById('video-file-input').addEventListener('change', handleVideoSelect);
            document.getElementById('subtitle-file-input').addEventListener('change', handleSubtitleSelect);
            
            // Playback
            document.getElementById('play-video-btn').addEventListener('click', playVideo);
            document.getElementById('prev-subtitle-btn').addEventListener('click', prevSubtitle);
            document.getElementById('next-subtitle-btn').addEventListener('click', nextSubtitle);
            
            // Mining
            document.getElementById('mine-selection-btn').addEventListener('click', mineFromWatch);
            document.getElementById('ws-mine-btn').addEventListener('click', mineFromWebSocket);
            document.getElementById('save-vocab-btn').addEventListener('click', saveVocab);
            document.getElementById('cancel-mining-btn').addEventListener('click', closeMiningForm);
            
            // Vocab manager
            document.getElementById('export-all-btn').addEventListener('click', exportAllVocab);
            document.getElementById('export-new-btn').addEventListener('click', exportNewVocab);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            document.getElementById('import-file-input').addEventListener('change', handleImport);
            document.getElementById('delete-all-btn').addEventListener('click', deleteAllVocab);
            document.getElementById('close-vocab-btn').addEventListener('click', closeVocabManager);
            
            // WebSocket
            document.getElementById('ws-connect-btn').addEventListener('click', connectWebSocket);
            document.getElementById('ws-disconnect-btn').addEventListener('click', disconnectWebSocket);
        }

        // View Management
        function showMainView() {
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('watch-view').style.display = 'none';
            document.getElementById('websocket-view').style.display = 'none';
            document.getElementById('home-btn').style.display = 'none';
        }

        function showWatchView() {
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('watch-view').style.display = 'block';
            document.getElementById('websocket-view').style.display = 'none';
            document.getElementById('home-btn').style.display = 'block';
        }

        function showWebSocketView() {
            document.getElementById('main-view').style.display = 'none';
            document.getElementById('watch-view').style.display = 'none';
            document.getElementById('websocket-view').style.display = 'block';
            document.getElementById('home-btn').style.display = 'block';
        }

        function showVocabManager() {
            document.getElementById('vocab-manager-modal').classList.add('show');
            updateVocabStats();
        }

        function closeVocabManager() {
            document.getElementById('vocab-manager-modal').classList.remove('show');
        }

        // File Handling
        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedVideo = file;
                const info = document.getElementById('video-filename');
                info.textContent = `Selected: ${file.name}`;
                info.style.display = 'block';
                checkPlayButton();
            }
        }

        async function handleSubtitleSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedSubtitle = file;
                const info = document.getElementById('subtitle-filename');
                info.textContent = `Selected: ${file.name}`;
                info.style.display = 'block';
                
                const text = await file.text();
                subtitles = parseSRT(text);
                console.log(`Loaded ${subtitles.length} subtitles`);
                
                checkPlayButton();
            }
        }

        function checkPlayButton() {
            const playBtn = document.getElementById('play-video-btn');
            if (selectedVideo && selectedSubtitle) {
                playBtn.disabled = false;
            }
        }

        function parseSRT(text) {
            const blocks = text.trim().split(/\n\s*\n/);
            return blocks.map(block => {
                const lines = block.split('\n');
                if (lines.length >= 3) {
                    const textLines = lines.slice(2).join(' ');
                    return { text: textLines.trim() };
                }
                return null;
            }).filter(Boolean);
        }

        function playVideo() {
            const video = document.getElementById('video-player');
            video.src = URL.createObjectURL(selectedVideo);
            document.getElementById('video-container').style.display = 'block';
            
            currentSubIndex = 0;
            displaySubtitle(currentSubIndex);
        }

        function displaySubtitle(index) {
            if (index < 0 || index >= subtitles.length) return;
            
            const subtitle = subtitles[index];
            document.getElementById('subtitle-display').textContent = subtitle.text;
            document.getElementById('subtitle-counter').textContent = `${index + 1} / ${subtitles.length}`;
        }

        function prevSubtitle() {
            if (currentSubIndex > 0) {
                currentSubIndex--;
                displaySubtitle(currentSubIndex);
            }
        }

        function nextSubtitle() {
            if (currentSubIndex < subtitles.length - 1) {
                currentSubIndex++;
                displaySubtitle(currentSubIndex);
            }
        }

        // Mining
        function mineFromWatch() {
            const selection = window.getSelection().toString().trim();
            if (!selection) {
                alert('Please select some text first');
                return;
            }
            
            showMiningForm(selection, subtitles[currentSubIndex]?.text || '');
        }

        function mineFromWebSocket() {
            const selection = window.getSelection().toString().trim();
            if (!selection) {
                alert('Please select some text first');
                return;
            }
            
            const fullText = document.getElementById('ws-text-display').textContent;
            showMiningForm(selection, fullText);
        }

        function showMiningForm(word, sentence) {
            document.getElementById('expr-input').value = word;
            document.getElementById('expr-furigana-input').value = word;
            document.getElementById('def-input').value = '';
            document.getElementById('sentence-input').value = sentence;
            
            document.getElementById('mining-modal').classList.add('show');
        }

        function closeMiningForm() {
            document.getElementById('mining-modal').classList.remove('show');
        }

        async function saveVocab() {
            const entry = {
                Expression: document.getElementById('expr-input').value.trim(),
                ExpressionFurigana: document.getElementById('expr-furigana-input').value.trim(),
                MainDefinition: document.getElementById('def-input').value.trim(),
                Sentence: document.getElementById('sentence-input').value.trim(),
                timestamp: Date.now(),
                exported: false,
                ExpressionReading: '',
                ExpressionAudio: '',
                SelectionText: '',
                DefinitionPicture: '',
                SentenceFurigana: '',
                SentenceAudio: '',
                Picture: '',
                Glossary: '',
                Hint: '',
                IsWordAndSentenceCard: '',
                IsClickCard: '',
                IsSentenceCard: '',
                IsAudioCard: '',
                PitchPosition: '',
                PitchCategories: '',
                Frequency: '',
                FreqSort: '',
                MiscInfo: ''
            };
            
            if (!entry.Expression) {
                alert('Expression cannot be empty');
                return;
            }
            
            const tx = vocabDB.transaction('vocabulary', 'readwrite');
            await tx.objectStore('vocabulary').put(entry);
            
            closeMiningForm();
            alert('‚úÖ Saved to vocabulary!');
        }

        // Vocabulary Management
        async function updateVocabStats() {
            const tx = vocabDB.transaction('vocabulary', 'readonly');
            const store = tx.objectStore('vocabulary');
            const count = await store.count();
            
            document.getElementById('vocab-count').textContent = count.result || 0;
        }

        async function exportAllVocab() {
            const tx = vocabDB.transaction('vocabulary', 'readonly');
            const store = tx.objectStore('vocabulary');
            const request = store.getAll();
            
            request.onsuccess = () => {
                downloadCSV(request.result);
            };
        }

        async function exportNewVocab() {
            const tx = vocabDB.transaction('vocabulary', 'readonly');
            const store = tx.objectStore('vocabulary');
            const index = store.index('exported');
            const request = index.getAll(false);
            
            request.onsuccess = () => {
                downloadCSV(request.result);
                markAsExported(request.result);
            };
        }

        async function markAsExported(entries) {
            const tx = vocabDB.transaction('vocabulary', 'readwrite');
            const store = tx.objectStore('vocabulary');
            
            for (const entry of entries) {
                entry.exported = true;
                store.put(entry);
            }
        }

        function downloadCSV(entries) {
            const headers = ['Expression', 'ExpressionFurigana', 'ExpressionReading', 'ExpressionAudio', 'SelectionText', 'MainDefinition', 'DefinitionPicture', 'Sentence', 'SentenceFurigana', 'SentenceAudio', 'Picture', 'Glossary', 'Hint', 'IsWordAndSentenceCard', 'IsClickCard', 'IsSentenceCard', 'IsAudioCard', 'PitchPosition', 'PitchCategories', 'Frequency', 'FreqSort', 'MiscInfo'];
            
            let csv = headers.join('\t') + '\n';
            
            entries.forEach(entry => {
                const row = headers.map(h => (entry[h] || '').toString().replace(/\t/g, ' ')).join('\t');
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/tab-separated-values;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vocabulary_${Date.now()}.tsv`;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('last-export').textContent = new Date().toLocaleString();
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const text = await file.text();
            const lines = text.split('\n');
            const headers = lines[0].split('\t');
            
            const tx = vocabDB.transaction('vocabulary', 'readwrite');
            const store = tx.objectStore('vocabulary');
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split('\t');
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header.trim()] = values[index] || '';
                });
                entry.timestamp = Date.now();
                entry.exported = false;
                
                if (entry.Expression) {
                    await store.put(entry);
                }
            }
            
            alert('‚úÖ Vocabulary imported!');
            updateVocabStats();
        }

        async function deleteAllVocab() {
            if (!confirm('Are you sure you want to delete ALL vocabulary? This cannot be undone.')) {
                return;
            }
            
            const tx = vocabDB.transaction('vocabulary', 'readwrite');
            await tx.objectStore('vocabulary').clear();
            
            alert('üóëÔ∏è All vocabulary deleted');
            updateVocabStats();
        }

        // WebSocket
        function connectWebSocket() {
            const url = document.getElementById('ws-url').value;
            if (!url) {
                alert('Please enter a WebSocket URL');
                return;
            }
            
            try {
                websocket = new WebSocket(url);
                
                websocket.onopen = () => {
                    document.getElementById('ws-status').textContent = 'Status: ‚úÖ Connected';
                    document.getElementById('ws-connect-btn').disabled = true;
                    document.getElementById('ws-disconnect-btn').disabled = false;
                };
                
                websocket.onmessage = (event) => {
                    document.getElementById('ws-text-display').textContent = event.data;
                };
                
                websocket.onerror = () => {
                    document.getElementById('ws-status').textContent = 'Status: ‚ùå Error';
                };
                
                websocket.onclose = () => {
                    document.getElementById('ws-status').textContent = 'Status: Disconnected';
                    document.getElementById('ws-connect-btn').disabled = false;
                    document.getElementById('ws-disconnect-btn').disabled = true;
                };
            } catch (error) {
                alert('Failed to connect: ' + error.message);
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }
    </script>
</body>
</html>